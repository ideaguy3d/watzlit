"use strict";angular.module("app",["firebase","angular-md5","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("home",{url:"/",templateUrl:"home/home.html",resolve:{requireNoAuth:["$state","jaAuth",function(a,b){return b.$requireSignIn().then(function(b){a.go("channels")},function(a){console.log("jha - user not signed in, in the 'home' state resolve.")})}]}}).state("login",{url:"/login",controller:"AuthCtrl as authCtrl",templateUrl:"auth/login.html",resolve:{requireNoAuth:["$state","jaAuth",function(a,b){return b.$requireSignIn().then(function(a){console.log(a)},function(a){console.log("ja - error with login state.")})}]}}).state("register",{url:"/register",controller:"AuthCtrl as authCtrl",templateUrl:"auth/register.html",resolve:{requireNoAuth:["$state","jaAuth",function(a,b){return b.$requireSignIn().then(function(b){a.go("home")},function(a){console.log("ja - error with register state.")})}]}}).state("profile",{url:"/profile",controller:"ProfileCtrl as profileCtrl",templateUrl:"users/profile.tem.html",resolve:{auth:["$state","jUsers","jaAuth",function(a,b,c){return c.$requireSignIn().catch(function(){a.go("home")})}],profile:["jUsers","jaAuth",function(a,b){return b.$requireSignIn().then(function(b){return a.getProfile(b.uid).$loaded()})}]}}).state("channels",{url:"/channels",controller:"ChannelsCtrl as channelsCtrl",templateUrl:"channels/index.html",resolve:{channels:["jChannels",function(a){return a.$loaded()}],profile:["$state","jaAuth","jUsers",function(a,b,c){return b.$requireSignIn().then(function(b){return c.getProfile(b.uid).$loaded().then(function(b){return b.displayName?b:void a.go("profile")},function(b){console.log(b),a.go("home")})})}]}}).state("channels.create",{url:"/create",templateUrl:"channels/create.html",controller:"ChannelsCtrl as channelsCtrl"}).state("channels.messages",{url:"{channelId}/messages",controller:"MessagesCtrl as messagesCtrl",templateUrl:"channels/messages.html",resolve:{messages:["$stateParams","jMessages",function(a,b){return b.forChannel(a.channelId).$loaded()}],channelName:["$stateParams","channels",function(a,b){return"#"+b.$getRecord(a.channelId).name}]}}).state("channels.direct",{url:"/{uid}/messages/direct",templateUrl:"channels/messages.html",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:["$stateParams","jMessages","profile",function(a,b,c){return b.forUsers(a.uid,c.$id).$loaded()}],channelName:["$stateParams","jUsers",function(a,b){return b.all.$loaded().then(function(){return"@"+b.getDisplayName(a.uid)})}]}}),b.otherwise("/");var c={apiKey:"AIzaSyD2VdKZgPdu3twTWW09Fz8tEH9rWucozZI",authDomain:"ngfire-chat.firebaseapp.com",databaseURL:"https://ngfire-chat.firebaseio.com",storageBucket:"ngfire-chat.appspot.com",messagingSenderId:"909282110429"};firebase.initializeApp(c)}]),function(){function a(a){return a()}var b=angular.module("app"),c="jaAuth";b.factory(c,["$firebaseAuth",a])}(),function(){function a(a,b){var c=this;c.user={email:"",password:""},c.login=function(){a.$signInWithEmailAndPassword(c.user.email,c.user.password).then(function(a){console.log("auth = "),console.log(a),b.go("channels")},function(a){console.log(a),c.error=a})},c.register=function(){a.$createUserWithEmailAndPassword(c.user.email,c.user.password).then(function(a){console.log(a),c.login()},function(a){console.log(a),c.error=a})}}var b=angular.module("app"),c="AuthCtrl";b.controller(c,["jaAuth","$state",a])}(),function(){angular.module("app").factory("jUsers",["$firebaseArray","$firebaseObject",function(a,b){var c=firebase.database().ref("users"),d=a(c),e=firebase.database().ref(".info/connected");return{getProfile:function(a){return b(c.child(a))},getDisplayName:function(a){var b=d.$getRecord(a);return b.displayName},all:d,getGravatar:function(a){return"//www.gravatar.com/avatar/"+d.$getRecord(a).emailHash},setOnline:function(d){var f=b(e),g=a(c.child(d+"/online"));f.$watch(function(){f.$value===!0&&g.$add(!0).then(function(a){a.onDisconnect().remove()})})}}}])}(),function(){angular.module("app").controller("ProfileCtrl",["$state","md5","auth","profile",function(a,b,c,d){var e=this;e.profile=d,e.updateProfile=function(){e.profile.emailHash=b.createHash(c.email),e.profile.$save().then(function(){a.go("channels")})}}])}(),function(){angular.module("app").factory("jChannels",["$firebaseArray",function(a){var b=firebase.database().ref("channels");return a(b)}]).factory("jMessages",["$firebaseArray",function(a){var b=firebase.database().ref("channelMessages"),c=firebase.database().ref("userMessages");return{forChannel:function(c){return a(b.child(c))},forUsers:function(b,d){console.log("uid1 = "+b),console.log("uid2 = "+d),console.log("uid1 < uid2 = "+(b<d));var e=b<d?b+"/"+d:d+"/"+b;return a(c.child(e))}}}])}(),function(){angular.module("app").controller("ChannelsCtrl",["$state","jaAuth","jUsers","profile","channels",function(a,b,c,d,e){var f=this;c.setOnline(d.$id),f.channels=e,f.profile=d,f.getDisplayName=c.getDisplayName,f.getGravatar=c.getGravatar,f.users=c.all,f.newChannel={name:"",queryCode1:"?ja=julius-alvarado&randomInt="+Math.floor(1e3*Math.random()+1)},f.logout=function(){f.profile.online=null,f.profile.$save().then(function(){b.$signOut().then(function(){a.go("home")})})},f.createChannel=function(){f.channels.$add(f.newChannel).then(function(b){f.newChannel={name:"",queryCode1:"?ja=julius-alvarado&randomInt="+Math.floor(1e3*Math.random()+1e3)},a.go("channels.messages",{channelId:b.key})})}}])}(),function(){angular.module("app").controller("MessagesCtrl",["profile","channelName","messages",function(a,b,c){var d=this;d.messages=c,d.channelName=b,d.message="",d.sendMessage=function(){d.message.length>0&&d.messages.$add({uid:a.$id,body:d.message,timestamp:firebase.database.ServerValue.TIMESTAMP}).then(function(){d.message="",console.log("jha - message was posted to the server")})}}])}();